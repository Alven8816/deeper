<!DOCTYPE html>
<!-- Generated by pkgdown: do not edit by hand --><html lang="en">
<head>
<meta http-equiv="Content-Type" content="text/html; charset=UTF-8">
<meta charset="utf-8">
<meta http-equiv="X-UA-Compatible" content="IE=edge">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Deep Ensemble for Environmental Predictor • deeper</title>
<!-- jquery --><script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.4.1/jquery.min.js" integrity="sha256-CSXorXvZcTkaix6Yvo6HppcZGetbYMGWSFlBw8HfCJo=" crossorigin="anonymous"></script><!-- Bootstrap --><link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/twitter-bootstrap/3.4.1/css/bootstrap.min.css" integrity="sha256-bZLfwXAP04zRMK2BjiO8iu9pf4FbLqX6zitd+tIvLhE=" crossorigin="anonymous">
<script src="https://cdnjs.cloudflare.com/ajax/libs/twitter-bootstrap/3.4.1/js/bootstrap.min.js" integrity="sha256-nuL8/2cJ5NDSSwnKD8VqreErSWHtnEP9E7AySL+1ev4=" crossorigin="anonymous"></script><!-- bootstrap-toc --><link rel="stylesheet" href="bootstrap-toc.css">
<script src="bootstrap-toc.js"></script><!-- Font Awesome icons --><link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/5.12.1/css/all.min.css" integrity="sha256-mmgLkCYLUQbXn0B1SRqzHar6dCnv9oZFPEC1g1cwlkk=" crossorigin="anonymous">
<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/5.12.1/css/v4-shims.min.css" integrity="sha256-wZjR52fzng1pJHwx4aV2AO3yyTOXrcDW7jBpJtTwVxw=" crossorigin="anonymous">
<!-- clipboard.js --><script src="https://cdnjs.cloudflare.com/ajax/libs/clipboard.js/2.0.6/clipboard.min.js" integrity="sha256-inc5kl9MA1hkeYUt+EC3BhlIgyp/2jDIyBLS6k3UxPI=" crossorigin="anonymous"></script><!-- headroom.js --><script src="https://cdnjs.cloudflare.com/ajax/libs/headroom/0.11.0/headroom.min.js" integrity="sha256-AsUX4SJE1+yuDu5+mAVzJbuYNPHj/WroHuZ8Ir/CkE0=" crossorigin="anonymous"></script><script src="https://cdnjs.cloudflare.com/ajax/libs/headroom/0.11.0/jQuery.headroom.min.js" integrity="sha256-ZX/yNShbjqsohH1k95liqY9Gd8uOiE1S4vZc+9KQ1K4=" crossorigin="anonymous"></script><!-- pkgdown --><link href="pkgdown.css" rel="stylesheet">
<script src="pkgdown.js"></script><meta property="og:title" content="Deep Ensemble for Environmental Predictor">
<meta property="og:description" content="The package provides a multiple-level stacked ensemble machine learning (DEML) framework 
    for improving the estimation of the air pollution concentrations.It can be viewed as 
    an extension of package SuperLearner, but achieve an improving prediction accuracy.">
<!-- mathjax --><script src="https://cdnjs.cloudflare.com/ajax/libs/mathjax/2.7.5/MathJax.js" integrity="sha256-nvJJv9wWKEm88qvoQl9ekL2J+k/RWIsaSScxxlsrv8k=" crossorigin="anonymous"></script><script src="https://cdnjs.cloudflare.com/ajax/libs/mathjax/2.7.5/config/TeX-AMS-MML_HTMLorMML.js" integrity="sha256-84DKXVJXs0/F8OTMzX4UR909+jtl4G7SPypPavF+GfA=" crossorigin="anonymous"></script><!--[if lt IE 9]>
<script src="https://oss.maxcdn.com/html5shiv/3.7.3/html5shiv.min.js"></script>
<script src="https://oss.maxcdn.com/respond/1.4.2/respond.min.js"></script>
<![endif]-->
</head>
<body data-spy="scroll" data-target="#toc">
    

    <div class="container template-home">
      <header><div class="navbar navbar-default navbar-fixed-top" role="navigation">
  <div class="container">
    <div class="navbar-header">
      <button type="button" class="navbar-toggle collapsed" data-toggle="collapse" data-target="#navbar" aria-expanded="false">
        <span class="sr-only">Toggle navigation</span>
        <span class="icon-bar"></span>
        <span class="icon-bar"></span>
        <span class="icon-bar"></span>
      </button>
      <span class="navbar-brand">
        <a class="navbar-link" href="index.html">deeper</a>
        <span class="version label label-default" data-toggle="tooltip" data-placement="bottom" title="">1.0.0</span>
      </span>
    </div>

    <div id="navbar" class="navbar-collapse collapse">
      <ul class="nav navbar-nav">
<li>
  <a href="reference/index.html">Reference</a>
</li>
<li>
  <a href="news/index.html">Changelog</a>
</li>
      </ul>
<ul class="nav navbar-nav navbar-right">
<li>
  <a href="https://github.com/Alven8816/deeper/" class="external-link">
    <span class="fab fa-github fa-lg"></span>
     
  </a>
</li>
      </ul>
</div>
<!--/.nav-collapse -->
  </div>
<!--/.container -->
</div>
<!--/.navbar -->

      

      </header><div class="row">
  <div class="contents col-md-9">

<div class="section level1">
<div class="page-header"><h1 id="deeperdeep-ensemble-for-environmental-predictor">deeper:Deep Ensemble for Environmental Predictor<a class="anchor" aria-label="anchor" href="#deeperdeep-ensemble-for-environmental-predictor"></a>
</h1></div>
<p>Alven Yu 2022/03/03</p>
<ul>
<li>
<a href="#the-framework-of-deml-model">The framework of DEML model</a>
<ul>
<li><a href="#-step-1-establish-the-base-models">* Step 1: establish the base models</a></li>
<li><a href="#-step-2-stack-the-meta-models">* Step 2: stack the meta models</a></li>
<li><a href="#-step-3-prediction-based-on-the-new-data-set">* Step 3: prediction based on the new data set</a></li>
</ul>
</li>
<li><a href="#installation">Installation</a></li>
<li>
<a href="#example">Example</a>
<ul>
<li>
<a href="#1-data-preparation">1. Data preparation</a>
<ul>
<li><a href="#load-the-example-data-and-separate-to-training-and-testing-dataset">Load the example data and separate to training and testing dataset</a></li>
<li><a href="#identify-the-dependence-and-independence-variables">Identify the dependence and independence variables</a></li>
</ul>
</li>
<li><a href="#2the-models-can-be-used">2.The models can be used</a></li>
<li><a href="#3model-building">3.Model Building</a></li>
<li><a href="#31-tuning-the-paramaters-of-a-base-model">3.1 Tuning the paramaters of a base model</a></li>
<li>
<a href="#32-establish-deml-model">3.2 Establish DEML model</a>
<ul>
<li><a href="#321-training-the-base-ensemble-model">3.2.1 Training the (base) ensemble model</a></li>
<li><a href="#322-training-the-base-ensemble-model-with-parallel-computing">3.2.2 Training the (base) ensemble model with parallel computing</a></li>
</ul>
</li>
<li>
<a href="#33-stacked-meta-models">3.3 Stacked meta models</a>
<ul>
<li><a href="#331-stacked-meta-models-based-on-trained-base-models">3.3.1 Stacked meta models based on trained base models</a></li>
<li><a href="#332-stacked-meta-models-from-scratch">3.3.2 Stacked meta models from scratch</a></li>
<li><a href="#333-stacked-meta-models-with-paralleling-computing">3.3.3 Stacked meta models with paralleling computing</a></li>
</ul>
</li>
<li>
<a href="#4-cross-validation-with-paralleling-computing">4. Cross validation with paralleling computing</a>
<ul>
<li><a href="#41-cross-validation-with-base-models">4.1 Cross validation with base models</a></li>
<li><a href="#42-cross-validation-with-stacked-meta-models">4.2 Cross validation with stacked meta models</a></li>
</ul>
</li>
<li><a href="#5-assess-and-plot-the-results">5. Assess and plot the results</a></li>
<li><a href="#citation">Citation</a></li>
</ul>
</li>
</ul>
<!-- badges: start -->
<div class="section level2">
<h2 id="the-framework-of-deml-model">The framework of DEML model<a class="anchor" aria-label="anchor" href="#the-framework-of-deml-model"></a>
</h2>
<p>The goal of deeper is to develop a multiple-level deep ensemble machine learning framework (DEML) for improving the estimation of air pollution concentrations.</p>
<p><a href="%22https://ehp.niehs.nih.gov/cms/asset/f6469ec0-3082-4a78-acb9-a95c988e73db/ehp9752_f1.gif%22" class="external-link">framework</a></p>
<p>The DEML framework proposed in this study is a three-level stacked ensemble approach. It is based on the SuperLearner(SL) ensemble algorithm (Naimi and Balzer 2018; Polley and Van Der Laan 2010; Van der Laan et al. 2007) introduced in the neural network hierarchy structure. Figure above illustrates the overall training procedure of our DEML algorithm.</p>
<p>Our newly build R package mainly include 3 steps:</p>
<div class="section level3">
<h3 id="-step-1-establish-the-base-models">* Step 1: establish the base models<a class="anchor" aria-label="anchor" href="#-step-1-establish-the-base-models"></a>
</h3>
<p>Using predictModel() or predictModel_parallel() to establish the base models. A tuningModel() function can be used to tuning the parameters to get the best single base model.</p>
</div>
<div class="section level3">
<h3 id="-step-2-stack-the-meta-models">* Step 2: stack the meta models<a class="anchor" aria-label="anchor" href="#-step-2-stack-the-meta-models"></a>
</h3>
<p>We use stack_ensemble(),stack_ensemble.fit(), or stack_ensemble_parallel() function to stack the meta models to get a DEML model.</p>
</div>
<div class="section level3">
<h3 id="-step-3-prediction-based-on-the-new-data-set">* Step 3: prediction based on the new data set<a class="anchor" aria-label="anchor" href="#-step-3-prediction-based-on-the-new-data-set"></a>
</h3>
<p>After establishment of DEML model, the predict() can be used predict the unseen data set.</p>
<p>To assess the performance of the models, assess.plot() can be used by comparing the original observations (y in test set) and the prediction. The assess.plot() also return the point scatter plot.</p>
<p>The other functions including CV.predictModel() (referred from SuperLearner), CV.predictModel_parallel(),and CV.stack_ensemble_parallel() could be used to conduct the external cross validation to assess the base models and DEML models for each fold.</p>
<p><strong>Note: DEML could not directly deal with missing values and missing value imputation technologies is recommended prior to the use of the DEML model.</strong></p>
<hr>
</div>
</div>
<div class="section level2">
<h2 id="installation">Installation<a class="anchor" aria-label="anchor" href="#installation"></a>
</h2>
<p>You can install the developing version of deeper from <a href="https://github.com/Alven8816/deeper" class="external-link">github</a> with:</p>
<div class="sourceCode" id="cb1"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span class="kw"><a href="https://rdrr.io/r/base/library.html" class="external-link">library</a></span><span class="op">(</span><span class="va"><a href="https://devtools.r-lib.org/" class="external-link">devtools</a></span><span class="op">)</span>
<span class="fu">install_github</span><span class="op">(</span><span class="st">"Alven8816/deeper"</span><span class="op">)</span></code></pre></div>
<hr>
</div>
</div>
<div class="section level1">
<h1 id="example">Example<a class="anchor" aria-label="anchor" href="#example"></a>
</h1>
<p>This is a basic example which shows you how to use deeper:</p>
<div class="section level2">
<h2 id="1-data-preparation">1. Data preparation<a class="anchor" aria-label="anchor" href="#1-data-preparation"></a>
</h2>
<div class="section level3">
<h3 id="load-the-example-data-and-separate-to-training-and-testing-dataset">Load the example data and separate to training and testing dataset<a class="anchor" aria-label="anchor" href="#load-the-example-data-and-separate-to-training-and-testing-dataset"></a>
</h3>
<div class="sourceCode" id="cb2"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span class="kw"><a href="https://rdrr.io/r/base/library.html" class="external-link">library</a></span><span class="op">(</span><span class="va"><a href="https://github.com/Alven8816/deeper" class="external-link">deeper</a></span><span class="op">)</span>

<span class="co">## obtain the example data</span>
<span class="fu"><a href="https://rdrr.io/r/utils/data.html" class="external-link">data</a></span><span class="op">(</span><span class="st">"envir_example"</span><span class="op">)</span></code></pre></div>
</div>
<div class="section level3">
<h3 id="identify-the-dependence-and-independence-variables">Identify the dependence and independence variables<a class="anchor" aria-label="anchor" href="#identify-the-dependence-and-independence-variables"></a>
</h3>
<div class="sourceCode" id="cb3"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span class="va">y</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="st">"PM2.5"</span><span class="op">)</span>
<span class="va">x</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/colnames.html" class="external-link">colnames</a></span><span class="op">(</span><span class="va">envir_example</span><span class="op">[</span><span class="op">-</span><span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="fl">1</span>, <span class="fl">6</span><span class="op">)</span><span class="op">]</span><span class="op">)</span> <span class="co"># except "date" and "PM2.5"</span></code></pre></div>
</div>
</div>
<div class="section level2">
<h2 id="2the-models-can-be-used">2.The models can be used<a class="anchor" aria-label="anchor" href="#2the-models-can-be-used"></a>
</h2>
<div class="sourceCode" id="cb4"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span class="co"># we need to select the algorithm previously</span>
<span class="fu">SuperLearner</span><span class="fu">::</span><span class="fu"><a href="https://rdrr.io/pkg/SuperLearner/man/listWrappers.html" class="external-link">listWrappers</a></span><span class="op">(</span><span class="op">)</span>
<span class="fu"><a href="https://rdrr.io/r/utils/data.html" class="external-link">data</a></span><span class="op">(</span><span class="va">model_list</span><span class="op">)</span> <span class="co"># get more details about the algorithm</span></code></pre></div>
<p>In the ‘type’ column, “R”: can be used for regression or classification;“N”: can be used for regression but variables requre to be numeric style; “C”: just used in classification.</p>
</div>
<div class="section level2">
<h2 id="3model-building">3.Model Building<a class="anchor" aria-label="anchor" href="#3model-building"></a>
</h2>
</div>
<div class="section level2">
<h2 id="31-tuning-the-paramaters-of-a-base-model">3.1 Tuning the paramaters of a base model<a class="anchor" aria-label="anchor" href="#31-tuning-the-paramaters-of-a-base-model"></a>
</h2>
<div class="sourceCode" id="cb5"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span class="co">#method 1: using deeper package function</span>
<span class="va">ranger</span> <span class="op">&lt;-</span>
  <span class="fu"><a href="reference/tuningModel.html">tuningModel</a></span><span class="op">(</span>
    basemodel  <span class="op">=</span> <span class="st">'SL.ranger'</span>,
    params <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/list.html" class="external-link">list</a></span><span class="op">(</span>num.trees <span class="op">=</span> <span class="fl">100</span><span class="op">)</span>,
    tune <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/list.html" class="external-link">list</a></span><span class="op">(</span>mtry <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="fl">1</span>, <span class="fl">3</span>, <span class="fl">7</span><span class="op">)</span><span class="op">)</span>
  <span class="op">)</span>

<span class="co">#method 2: employ the Superlearner package "create.Learner" method</span>
<span class="co">#ranger &lt;- SuperLearner::create.Learner(base_learner = 'SL.ranger',params = list(num.trees = 1000),tune = list(mtry = c(1,3,7)))</span>

<span class="co">#method 3: create a function by oneself as follow</span>
<span class="co">#ranger &lt;- function(...){SL.ranger(...,num.trees = 1000)}</span></code></pre></div>
</div>
<div class="section level2">
<h2 id="32-establish-deml-model">3.2 Establish DEML model<a class="anchor" aria-label="anchor" href="#32-establish-deml-model"></a>
</h2>
<div class="section level3">
<h3 id="321-training-the-base-ensemble-model">3.2.1 Training the (base) ensemble model<a class="anchor" aria-label="anchor" href="#321-training-the-base-ensemble-model"></a>
</h3>
<div class="sourceCode" id="cb6"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span class="co">#training the model with new dataset</span>
<span class="co">#predict the model with several methods(here we choose XGBoost and Random Forest models)</span>

<span class="va">pred_m1</span> <span class="op">&lt;-</span>
  <span class="fu"><a href="reference/predictModel.html">predictModel</a></span><span class="op">(</span>
    Y <span class="op">=</span> <span class="va">trainset</span><span class="op">[</span>, <span class="va">y</span><span class="op">]</span>,
    X <span class="op">=</span> <span class="va">trainset</span><span class="op">[</span>, <span class="va">x</span><span class="op">]</span>,
    newX <span class="op">=</span> <span class="va">testset</span><span class="op">[</span>, <span class="va">x</span><span class="op">]</span>,
    base_model <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="st">"SL.xgboost"</span>, <span class="va">ranger</span><span class="op">)</span>,
    cvControl <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/list.html" class="external-link">list</a></span><span class="op">(</span>V <span class="op">=</span> <span class="fl">5</span><span class="op">)</span>
  <span class="op">)</span>

<span class="co"># return the newX prediction results</span>
<span class="co"># get the ensemble model(SL) result</span>
<span class="fu"><a href="https://rdrr.io/r/utils/head.html" class="external-link">head</a></span><span class="op">(</span><span class="va">pred_m1</span><span class="op">$</span><span class="va">ensemble_pre</span><span class="op">)</span>
<span class="co"># get the single base model results</span>
<span class="fu"><a href="https://rdrr.io/r/utils/head.html" class="external-link">head</a></span><span class="op">(</span><span class="va">pred_m1</span><span class="op">$</span><span class="va">single_pre</span><span class="op">)</span></code></pre></div>
<p>The results show the weight, R2, and the root-mean-square error (RMSE) of each model. “ranger_1”,“ranger_2”,“ranger_3” note the Random Forest model with parameters mtry = 1,3,7 separately.</p>
<p>The results show that mtry = 5 is the best RF model for this prediction.This method could be used to tune the suitable parameters for algorithms.</p>
<div class="sourceCode" id="cb7"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span class="co"># training the model with separate new data set</span>

<span class="va">pred_m2</span> <span class="op">&lt;-</span>
  <span class="fu"><a href="reference/predictModel.html">predictModel</a></span><span class="op">(</span>
    Y <span class="op">=</span> <span class="va">trainset</span><span class="op">[</span>, <span class="va">y</span><span class="op">]</span>,
    X <span class="op">=</span> <span class="va">trainset</span><span class="op">[</span>, <span class="va">x</span><span class="op">]</span>,
    base_model <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="st">"SL.xgboost"</span>, <span class="va">ranger</span><span class="op">)</span>,
    cvControl <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/list.html" class="external-link">list</a></span><span class="op">(</span>V <span class="op">=</span> <span class="fl">5</span><span class="op">)</span>
  <span class="op">)</span>

<span class="co"># predict the new dataset</span>
<span class="va">pred_m2_new</span> <span class="op">&lt;-</span> <span class="fu"><a href="reference/predict.html">predict</a></span><span class="op">(</span>object <span class="op">=</span> <span class="va">pred_m2</span>, newX <span class="op">=</span> <span class="va">testset</span><span class="op">[</span>, <span class="va">x</span><span class="op">]</span><span class="op">)</span></code></pre></div>
</div>
<div class="section level3">
<h3 id="322-training-the-base-ensemble-model-with-parallel-computing">3.2.2 Training the (base) ensemble model with parallel computing<a class="anchor" aria-label="anchor" href="#322-training-the-base-ensemble-model-with-parallel-computing"></a>
</h3>
<div class="sourceCode" id="cb8"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span class="co">## conduct the spatial CV</span>

<span class="co"># Create a list with 7 (folds) elements (each element contains index of rows to be considered on each fold)</span>

<span class="va">indices</span> <span class="op">&lt;-</span>
  <span class="fu">CAST</span><span class="fu">::</span><span class="fu">CreateSpacetimeFolds</span><span class="op">(</span><span class="va">trainset</span>, spacevar <span class="op">=</span> <span class="st">"code"</span>, k <span class="op">=</span> <span class="fl">7</span><span class="op">)</span>

<span class="co"># Rows of validation set on each fold</span>

<span class="va">v_raw</span> <span class="op">&lt;-</span> <span class="va">indices</span><span class="op">$</span><span class="va">indexOut</span>

<span class="fu"><a href="https://rdrr.io/r/base/names.html" class="external-link">names</a></span><span class="op">(</span><span class="va">v_raw</span><span class="op">)</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/seq.html" class="external-link">seq</a></span><span class="op">(</span><span class="fl">1</span><span class="op">:</span><span class="fl">7</span><span class="op">)</span>

<span class="va">pred_m3</span> <span class="op">&lt;-</span> <span class="fu"><a href="reference/predictModel_parallel.html">predictModel_parallel</a></span><span class="op">(</span>
  Y <span class="op">=</span> <span class="va">trainset</span><span class="op">[</span>, <span class="va">y</span><span class="op">]</span>,
  X <span class="op">=</span> <span class="va">trainset</span><span class="op">[</span>, <span class="va">x</span><span class="op">]</span>,
  base_model <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="st">"SL.xgboost"</span>, <span class="va">ranger</span><span class="op">)</span>,
  cvControl <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/list.html" class="external-link">list</a></span><span class="op">(</span>V <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/length.html" class="external-link">length</a></span><span class="op">(</span><span class="va">v_raw</span><span class="op">)</span>, validRows <span class="op">=</span> <span class="va">v_raw</span><span class="op">)</span>,
  number_cores <span class="op">=</span> <span class="fl">4</span>,
  seed <span class="op">=</span> <span class="fl">1</span>
<span class="op">)</span>
<span class="co">## when number_cores is missing, it will indicate user to set one based on the operation system.</span>

<span class="co"># pred_m3 &lt;- predictModel_parallel(</span>
<span class="co">#     Y = trainset[,y],</span>
<span class="co">#     X = trainset[,x],</span>
<span class="co">#     base_model = c("SL.xgboost",ranger),</span>
<span class="co">#     cvControl = list(V = length(v_raw), validRows = v_raw),</span>
<span class="co">#     seed = 1</span>
<span class="co">#   )</span>

<span class="co">#You have 8 cpu cores, How many cpu core you want to use:</span>
<span class="co"># type the number to continue the process.</span>


<span class="co"># prediction</span>
<span class="va">pred_m3_new</span> <span class="op">&lt;-</span> <span class="fu"><a href="reference/predict.html">predict</a></span><span class="op">(</span>object <span class="op">=</span> <span class="va">pred_m3</span>, newX <span class="op">=</span> <span class="va">testset</span><span class="op">[</span>, <span class="va">x</span><span class="op">]</span><span class="op">)</span></code></pre></div>
</div>
</div>
<div class="section level2">
<h2 id="33-stacked-meta-models">3.3 Stacked meta models<a class="anchor" aria-label="anchor" href="#33-stacked-meta-models"></a>
</h2>
<p>Our DEML model includes several meta-models based on the trained base models’ results. Different from other ensemble (stacking method), DEML model allow to select several meta-models and run them parallelly and ensemble all the meta-models with the optimal weights.(This step is optinal for analysis).</p>
<div class="section level3">
<h3 id="331-stacked-meta-models-based-on-trained-base-models">3.3.1 Stacked meta models based on trained base models<a class="anchor" aria-label="anchor" href="#331-stacked-meta-models-based-on-trained-base-models"></a>
</h3>
<div class="sourceCode" id="cb9"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span class="co">#Do not include original feature</span>
<span class="co"># object include newX dataset</span>
<span class="va">pre_stack_1</span> <span class="op">&lt;-</span>
  <span class="fu"><a href="reference/stack_ensemble.html">stack_ensemble</a></span><span class="op">(</span>
    object <span class="op">=</span> <span class="va">pred_m1</span>,
    meta_model <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="st">"SL.ranger"</span>, <span class="st">"SL.xgboost"</span>, <span class="st">"SL.lm"</span><span class="op">)</span>,
    original_feature <span class="op">=</span> <span class="cn">FALSE</span>
  <span class="op">)</span>


<span class="co"># object do not include newX dataset</span>
<span class="va">pre_stack_2</span> <span class="op">&lt;-</span>
  <span class="fu"><a href="reference/stack_ensemble.html">stack_ensemble</a></span><span class="op">(</span>
    object <span class="op">=</span> <span class="va">pred_m2</span>,
    meta_model <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="st">"SL.ranger"</span>, <span class="st">"SL.xgboost"</span>, <span class="st">"SL.lm"</span><span class="op">)</span>,
    original_feature <span class="op">=</span> <span class="cn">FALSE</span>,
    X <span class="op">=</span> <span class="va">testset</span><span class="op">[</span>, <span class="va">x</span><span class="op">]</span>
  <span class="op">)</span>

<span class="co"># prediction</span>
<span class="va">pred_stack_2_new</span> <span class="op">&lt;-</span> <span class="fu"><a href="reference/predict.html">predict</a></span><span class="op">(</span>object <span class="op">=</span> <span class="va">pre_stack_2</span>, newX <span class="op">=</span> <span class="va">testset</span><span class="op">[</span>, <span class="va">x</span><span class="op">]</span><span class="op">)</span>


<span class="co">#Do include original feature</span>
<span class="co">#object do not include newX dataset</span>
<span class="va">pre_stack_3</span> <span class="op">&lt;-</span>
  <span class="fu"><a href="reference/stack_ensemble.html">stack_ensemble</a></span><span class="op">(</span>
    object <span class="op">=</span> <span class="va">pred_m2</span>,
    meta_model <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="st">"SL.ranger"</span>, <span class="st">"SL.xgboost"</span>, <span class="st">"SL.lm"</span><span class="op">)</span>,
    original_feature <span class="op">=</span> <span class="cn">TRUE</span>,
    X <span class="op">=</span> <span class="va">trainset</span><span class="op">[</span>, <span class="va">x</span><span class="op">]</span>
  <span class="op">)</span>

<span class="co"># prediction</span>
<span class="va">pred_stack_3_new</span> <span class="op">&lt;-</span> <span class="fu"><a href="reference/predict.html">predict</a></span><span class="op">(</span>object <span class="op">=</span> <span class="va">pre_stack_2</span>, newX <span class="op">=</span> <span class="va">testset</span><span class="op">[</span>, <span class="va">x</span><span class="op">]</span><span class="op">)</span>

<span class="co">#object include newX dataset</span>
<span class="va">pre_stack_4</span> <span class="op">&lt;-</span>
  <span class="fu"><a href="reference/stack_ensemble.html">stack_ensemble</a></span><span class="op">(</span>
    object <span class="op">=</span> <span class="va">pred_m1</span>,
    meta_model <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="st">"SL.ranger"</span>, <span class="st">"SL.xgboost"</span>, <span class="st">"SL.lm"</span><span class="op">)</span>,
    original_feature <span class="op">=</span> <span class="cn">TRUE</span>,
    X <span class="op">=</span> <span class="va">trainset</span><span class="op">[</span>, <span class="va">x</span><span class="op">]</span>
  <span class="op">)</span>

<span class="co"># prediction</span>
<span class="va">pred_stack_4_new</span> <span class="op">&lt;-</span> <span class="fu"><a href="reference/predict.html">predict</a></span><span class="op">(</span>object <span class="op">=</span> <span class="va">pre_stack_4</span>, newX <span class="op">=</span> <span class="va">testset</span><span class="op">[</span>, <span class="va">x</span><span class="op">]</span><span class="op">)</span></code></pre></div>
</div>
<div class="section level3">
<h3 id="332-stacked-meta-models-from-scratch">3.3.2 Stacked meta models from scratch<a class="anchor" aria-label="anchor" href="#332-stacked-meta-models-from-scratch"></a>
</h3>
<div class="sourceCode" id="cb10"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span class="co">#Do not include original feature</span>
<span class="co"># put new dataset in the training</span>
<span class="va">pred_stack_5</span> <span class="op">&lt;-</span>
  <span class="fu"><a href="reference/stack_ensemble.fit.html">stack_ensemble.fit</a></span><span class="op">(</span>
    Y <span class="op">=</span> <span class="va">trainset</span><span class="op">[</span>, <span class="va">y</span><span class="op">]</span>,
    X <span class="op">=</span> <span class="va">trainset</span><span class="op">[</span>, <span class="va">x</span><span class="op">]</span>,
    newX <span class="op">=</span> <span class="va">testset</span><span class="op">[</span>, <span class="va">x</span><span class="op">]</span>,
    base_model <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="st">"SL.xgboost"</span>, <span class="va">ranger</span><span class="op">)</span>,
    meta_model <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="st">"SL.ranger"</span>, <span class="st">"SL.xgboost"</span>, <span class="st">"SL.glm"</span><span class="op">)</span>,
    original_feature <span class="op">=</span> <span class="cn">FALSE</span>
  <span class="op">)</span>


<span class="co"># predict new dataset separately</span>

<span class="va">pred_stack_6</span> <span class="op">&lt;-</span>
  <span class="fu"><a href="reference/stack_ensemble.fit.html">stack_ensemble.fit</a></span><span class="op">(</span>
    Y <span class="op">=</span> <span class="va">trainset</span><span class="op">[</span>, <span class="va">y</span><span class="op">]</span>,
    X <span class="op">=</span> <span class="va">trainset</span><span class="op">[</span>, <span class="va">x</span><span class="op">]</span>,
    base_model <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="st">"SL.xgboost"</span>, <span class="va">ranger</span><span class="op">)</span>,
    meta_model <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="st">"SL.ranger"</span>, <span class="st">"SL.xgboost"</span>, <span class="st">"SL.glm"</span><span class="op">)</span>,
    original_feature <span class="op">=</span> <span class="cn">FALSE</span>
  <span class="op">)</span>

<span class="va">pred_stack_6_new</span> <span class="op">&lt;-</span>
  <span class="fu"><a href="reference/predict.html">predict</a></span><span class="op">(</span>object <span class="op">=</span> <span class="va">pred_stack_6</span>, newX <span class="op">=</span> <span class="va">testset</span><span class="op">[</span>, <span class="va">x</span><span class="op">]</span><span class="op">)</span>

<span class="co">#Include original feature</span>
<span class="co"># put new dataset in the training</span>
<span class="va">pred_stack_7</span> <span class="op">&lt;-</span>
  <span class="fu"><a href="reference/stack_ensemble.fit.html">stack_ensemble.fit</a></span><span class="op">(</span>
    Y <span class="op">=</span> <span class="va">trainset</span><span class="op">[</span>, <span class="va">y</span><span class="op">]</span>,
    X <span class="op">=</span> <span class="va">trainset</span><span class="op">[</span>, <span class="va">x</span><span class="op">]</span>,
    newX <span class="op">=</span> <span class="va">testset</span><span class="op">[</span>, <span class="va">x</span><span class="op">]</span>,
    base_model <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="st">"SL.xgboost"</span>, <span class="va">ranger</span><span class="op">)</span>,
    meta_model <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="st">"SL.ranger"</span>, <span class="st">"SL.xgboost"</span>, <span class="st">"SL.glm"</span><span class="op">)</span>,
    original_feature <span class="op">=</span> <span class="cn">TRUE</span>
  <span class="op">)</span>

<span class="co"># predict new dataset separately</span>

<span class="va">pred_stack_8</span> <span class="op">&lt;-</span>
  <span class="fu"><a href="reference/stack_ensemble.fit.html">stack_ensemble.fit</a></span><span class="op">(</span>
    Y <span class="op">=</span> <span class="va">trainset</span><span class="op">[</span>, <span class="va">y</span><span class="op">]</span>,
    X <span class="op">=</span> <span class="va">trainset</span><span class="op">[</span>, <span class="va">x</span><span class="op">]</span>,
    base_model <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="st">"SL.xgboost"</span>, <span class="va">ranger</span><span class="op">)</span>,
    meta_model <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="st">"SL.ranger"</span>, <span class="st">"SL.xgboost"</span>, <span class="st">"SL.glm"</span><span class="op">)</span>,
    original_feature <span class="op">=</span> <span class="cn">TRUE</span>
  <span class="op">)</span>

<span class="va">pred_stack_8_new</span> <span class="op">&lt;-</span>
  <span class="fu"><a href="reference/predict.html">predict</a></span><span class="op">(</span>object <span class="op">=</span> <span class="va">pred_stack_7</span>, newX <span class="op">=</span> <span class="va">testset</span><span class="op">[</span>, <span class="va">x</span><span class="op">]</span><span class="op">)</span></code></pre></div>
</div>
<div class="section level3">
<h3 id="333-stacked-meta-models-with-paralleling-computing">3.3.3 Stacked meta models with paralleling computing<a class="anchor" aria-label="anchor" href="#333-stacked-meta-models-with-paralleling-computing"></a>
</h3>
<div class="sourceCode" id="cb11"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span class="co">#Do not include original feature</span>
<span class="va">pred_stack_9</span> <span class="op">&lt;-</span>
  <span class="fu"><a href="reference/stack_ensemble_parallel.html">stack_ensemble_parallel</a></span><span class="op">(</span>
    object <span class="op">=</span> <span class="va">pred_m3</span>,
    Y <span class="op">=</span> <span class="va">trainset</span><span class="op">[</span>, <span class="va">y</span><span class="op">]</span>,
    meta_model <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="st">"SL.ranger"</span>, <span class="st">"SL.xgboost"</span>, <span class="st">"SL.glm"</span><span class="op">)</span>,
    original_feature <span class="op">=</span> <span class="cn">FALSE</span>,
    number_cores <span class="op">=</span> <span class="fl">4</span>
  <span class="op">)</span>
<span class="va">pred_stack_9_new</span> <span class="op">&lt;-</span>
  <span class="fu"><a href="reference/predict.html">predict</a></span><span class="op">(</span>object <span class="op">=</span> <span class="va">pred_stack_9</span>, newX <span class="op">=</span> <span class="va">testset</span><span class="op">[</span>, <span class="va">x</span><span class="op">]</span><span class="op">)</span>

<span class="co">#Include original feature</span>
<span class="va">pred_stack_10</span> <span class="op">&lt;-</span>
  <span class="fu"><a href="reference/stack_ensemble_parallel.html">stack_ensemble_parallel</a></span><span class="op">(</span>
    object <span class="op">=</span> <span class="va">pred_m3</span>,
    Y <span class="op">=</span> <span class="va">trainset</span><span class="op">[</span>, <span class="va">y</span><span class="op">]</span>,
    meta_model <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="st">"SL.ranger"</span>, <span class="st">"SL.xgboost"</span>, <span class="st">"SL.glm"</span><span class="op">)</span>,
    original_feature <span class="op">=</span> <span class="cn">TRUE</span>,
    X <span class="op">=</span> <span class="va">trainset</span><span class="op">[</span>, <span class="va">x</span><span class="op">]</span>,
    number_cores <span class="op">=</span> <span class="fl">4</span>
  <span class="op">)</span>

<span class="va">pred_stack_10_new</span> <span class="op">&lt;-</span>
  <span class="fu"><a href="reference/predict.html">predict</a></span><span class="op">(</span>object <span class="op">=</span> <span class="va">pred_stack_10</span>, newX <span class="op">=</span> <span class="va">testset</span><span class="op">[</span>, <span class="va">x</span><span class="op">]</span><span class="op">)</span></code></pre></div>
</div>
</div>
<div class="section level2">
<h2 id="4-cross-validation-with-paralleling-computing">4. Cross validation with paralleling computing<a class="anchor" aria-label="anchor" href="#4-cross-validation-with-paralleling-computing"></a>
</h2>
<p>Besides the CV for single base/meta model, an ‘external’ CV for the whole ensemble model is necessary to assess the performance of DEML modle.</p>
<p>Typically, we conduct a separate holdout sample approach to see the performance of DEML on unseen data.</p>
<div class="section level3">
<h3 id="41-cross-validation-with-base-models">4.1 Cross validation with base models<a class="anchor" aria-label="anchor" href="#41-cross-validation-with-base-models"></a>
</h3>
<div class="sourceCode" id="cb12"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span class="va">pred_m1_cv</span> <span class="op">&lt;-</span> <span class="fu"><a href="reference/CV.predictModel_parallel.html">CV.predictModel_parallel</a></span><span class="op">(</span>
  Y <span class="op">=</span> <span class="va">trainset</span><span class="op">[</span>, <span class="va">y</span><span class="op">]</span>,
  X <span class="op">=</span> <span class="va">trainset</span><span class="op">[</span>, <span class="va">x</span><span class="op">]</span>,
  base_model <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="st">"SL.xgboost"</span>, <span class="st">"SL.ranger"</span><span class="op">)</span>,
  number_cores <span class="op">=</span> <span class="fl">4</span>
<span class="op">)</span></code></pre></div>
</div>
<div class="section level3">
<h3 id="42-cross-validation-with-stacked-meta-models">4.2 Cross validation with stacked meta models<a class="anchor" aria-label="anchor" href="#42-cross-validation-with-stacked-meta-models"></a>
</h3>
<div class="sourceCode" id="cb13"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span class="co">#Include original feature</span>
<span class="va">pred_stack_cv_1</span> <span class="op">&lt;-</span> <span class="fu"><a href="reference/CV.stack_ensemble_parallel.html">CV.stack_ensemble_parallel</a></span><span class="op">(</span>
  object <span class="op">=</span> <span class="va">pred_m2</span>,
  Y <span class="op">=</span> <span class="va">trainset</span><span class="op">[</span>, <span class="va">y</span><span class="op">]</span>,
  X <span class="op">=</span> <span class="va">trainset</span><span class="op">[</span>, <span class="va">x</span><span class="op">]</span>,
  meta_model <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="st">"SL.xgboost"</span>, <span class="st">"SL.ranger"</span><span class="op">)</span>,
  original_feature <span class="op">=</span> <span class="cn">TRUE</span>,
  number_cores <span class="op">=</span> <span class="fl">4</span>
<span class="op">)</span>

<span class="co">#Do not include original feature</span>
<span class="va">pred_stack_cv_2</span> <span class="op">&lt;-</span>
  <span class="fu"><a href="reference/CV.stack_ensemble_parallel.html">CV.stack_ensemble_parallel</a></span><span class="op">(</span>
    object <span class="op">=</span> <span class="va">pred_m1</span>,
    Y <span class="op">=</span> <span class="va">trainset</span><span class="op">[</span>, <span class="va">y</span><span class="op">]</span>,
    X <span class="op">=</span> <span class="va">trainset</span><span class="op">[</span>, <span class="va">x</span><span class="op">]</span>,
    meta_model <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="st">"SL.xgboost"</span>, <span class="st">"SL.ranger"</span><span class="op">)</span>,
    original_feature <span class="op">=</span> <span class="cn">FALSE</span>,
    number_cores <span class="op">=</span> <span class="fl">4</span>
  <span class="op">)</span></code></pre></div>
</div>
</div>
<div class="section level2">
<h2 id="5-assess-and-plot-the-results">5. Assess and plot the results<a class="anchor" aria-label="anchor" href="#5-assess-and-plot-the-results"></a>
</h2>
<div class="sourceCode" id="cb14"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span class="va">test_p</span> <span class="op">&lt;-</span>
  <span class="fu"><a href="reference/assess.plot.html">assess.plot</a></span><span class="op">(</span>pre <span class="op">=</span> <span class="va">pred_stack_10_new</span><span class="op">$</span><span class="va">pre_meta</span><span class="op">$</span><span class="va">pred</span>, obs <span class="op">=</span> <span class="va">testset</span><span class="op">[</span>, <span class="va">y</span><span class="op">]</span><span class="op">)</span>

<span class="fu"><a href="https://rdrr.io/r/base/print.html" class="external-link">print</a></span><span class="op">(</span><span class="va">test_p</span><span class="op">$</span><span class="va">plot</span><span class="op">)</span></code></pre></div>
</div>
<div class="section level2">
<h2 id="citation">Citation<a class="anchor" aria-label="anchor" href="#citation"></a>
</h2>
<p>Wenhua Yu, Shanshan Li, Tingting Ye,Rongbin Xu, Jiangning Song, Yuming Guo (2022) Deep ensemble machine learning framework for the estimation of PM2.5 concentrations,Environmental health perspectives: <a href="https://doi.org/10.1289/EHP9752" class="external-link uri">https://doi.org/10.1289/EHP9752</a></p>
</div>
</div>

  </div>

  <div class="col-md-3 hidden-xs hidden-sm" id="pkgdown-sidebar">
    <div class="links">
<h2 data-toc-skip>Links</h2>
<ul class="list-unstyled">
<li><a href="https://github.com/Alven8816/deeper/" class="external-link">Browse source code</a></li>
<li><a href="https://github.com/Alven8816/deeper/issues" class="external-link">Report a bug</a></li>
</ul>
</div>

<div class="license">
<h2 data-toc-skip>License</h2>
<ul class="list-unstyled">
<li><a href="LICENSE.html">Full license</a></li>
<li><small>GPL (&gt;= 3)</small></li>
</ul>
</div>


<div class="citation">
<h2 data-toc-skip>Citation</h2>
<ul class="list-unstyled">
<li><a href="authors.html#citation">Citing deeper</a></li>
</ul>
</div>

<div class="developers">
<h2 data-toc-skip>Developers</h2>
<ul class="list-unstyled">
<li>Wenhua Yu <br><small class="roles"> Author, maintainer </small>  </li>
<li>Yuming Guo <br><small class="roles"> Author </small>  </li>
</ul>
</div>

<div class="dev-status">
<h2 data-toc-skip>Dev status</h2>
<ul class="list-unstyled">
<li><a href="https://codecov.io/gh/Alven8816/deeper_1.0.0?branch=master" class="external-link"><img src="https://codecov.io/gh/Alven8816/deeper_1.0.0/branch/master/graph/badge.svg" alt="Codecov test coverage"></a></li>
<li><a href="https://github.com/Alven8816/deeper_1.0.0/actions" class="external-link"><img src="https://github.com/Alven8816/deeper_1.0.0/workflows/R-CMD-check/badge.svg" alt="R-CMD-check"></a></li>
</ul>
</div>

  </div>
</div>


      <footer><div class="copyright">
  <p></p>
<p>Developed by Wenhua Yu, Yuming Guo.</p>
</div>

<div class="pkgdown">
  <p></p>
<p>Site built with <a href="https://pkgdown.r-lib.org/" class="external-link">pkgdown</a> 2.0.2.</p>
</div>

      </footer>
</div>

  


  

  </body>
</html>
